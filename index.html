<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MVP Calendario de Clases</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FullCalendar CSS (v5) -->
    <link href='https://cdn.jsdelivr.net/npm/@fullcalendar/core@5.11.3/main.min.css' rel='stylesheet' />
    <link href='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@5.11.3/main.min.css' rel='stylesheet' />
    <link href='https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@5.11.3/main.min.css' rel='stylesheet' />
    <!-- FullCalendar JS (v5) -->
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@5.11.3/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@5.11.3/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@5.11.3/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@5.11.3/main.min.js'></script>
    <!-- Fuente opcional -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Ajustes personalizados para FullCalendar */
        .fc .fc-toolbar-title { font-size: 1.25rem; font-weight: 600; color: #1f2937; }
        .fc .fc-button-primary { background-color: #2563eb; border-color: #2563eb; }
        .fc .fc-button-primary:hover { background-color: #1d4ed8; border-color: #1d4ed8; }
        .fc .fc-col-header-cell-cushion { color: #374151; font-weight: 500; }
        .fc .fc-timegrid-slot-label { color: #4b5563; }
    </style>
</head>
<body class="bg-gray-50 p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Cabecera con bot√≥n a√±adir y hoy -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-4 md:mb-0">üìÖ Calendario de Clases (MVP)</h1>
            <div class="flex gap-3">
                <button id="openModalBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow transition flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    A√±adir clase
                </button>
                <button id="todayBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg shadow transition">
                    Hoy
                </button>
            </div>
        </div>

        <!-- Leyenda de profesores (colores) -->
        <div class="flex flex-wrap gap-4 mb-4 text-sm">
            <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-blue-500 mr-2"></span> Prof. Ana (Matem√°ticas)</div>
            <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-green-500 mr-2"></span> Prof. Luis (F√≠sica)</div>
            <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-orange-500 mr-2"></span> Prof. Carla (Qu√≠mica)</div>
            <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-purple-500 mr-2"></span> Prof. Marta (Historia)</div>
        </div>

        <!-- Contenedor del calendario -->
        <div id="calendar" class="bg-white p-4 rounded-xl shadow-lg"></div>
    </div>

    <!-- Modal para a√±adir/editar clase (reutilizable) -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 mx-4">
            <h2 id="modalTitle" class="text-2xl font-bold text-gray-800 mb-4">‚ûï Nueva clase</h2>
            <form id="classForm">
                <!-- Campo oculto para el ID del evento (cuando se edita) -->
                <input type="hidden" id="eventId" value="">
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">T√≠tulo de la clase</label>
                    <input type="text" id="title" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Ej. Matem√°ticas avanzadas">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Profesor</label>
                    <select id="professor" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <option value="Ana">Prof. Ana (Matem√°ticas)</option>
                        <option value="Luis">Prof. Luis (F√≠sica)</option>
                        <option value="Carla">Prof. Carla (Qu√≠mica)</option>
                        <option value="Marta">Prof. Marta (Historia)</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">D√≠a</label>
                        <select id="day" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                            <option value="1">Lunes</option>
                            <option value="2">Martes</option>
                            <option value="3">Mi√©rcoles</option>
                            <option value="4">Jueves</option>
                            <option value="5">Viernes</option>
                            <option value="6">S√°bado</option>
                            <option value="0">Domingo</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Color</label>
                        <select id="color" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                            <option value="blue">Azul</option>
                            <option value="green">Verde</option>
                            <option value="orange">Naranja</option>
                            <option value="purple">Morado</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Hora inicio</label>
                        <input type="time" id="startTime" required value="09:00" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Hora fin</label>
                        <input type="time" id="endTime" required value="10:30" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                </div>
                <div class="flex justify-between gap-3">
                    <div>
                        <button type="button" id="deleteEventBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition hidden">Eliminar</button>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" id="closeModalBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition">Cancelar</button>
                        <button type="submit" id="saveEventBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Guardar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        (function() {
            // ----- Configuraci√≥n de semana actual (lunes como inicio) -----
            function getStartOfWeek() {
                const today = new Date();
                const day = today.getDay(); // 0 domingo, 1 lunes...
                const diff = day === 0 ? -6 : 1 - day; // Ajuste para que la semana empiece en lunes
                const monday = new Date(today);
                monday.setDate(today.getDate() + diff);
                monday.setHours(0,0,0,0);
                return monday;
            }
            const baseDate = getStartOfWeek(); // lunes de la semana actual

            // Mapeo de d√≠as (0 domingo..6 s√°bado) a offset desde baseDate
            function getDateForDay(dayIndex) {
                const date = new Date(baseDate);
                if (dayIndex === 0) { // domingo
                    date.setDate(baseDate.getDate() + 6);
                } else {
                    date.setDate(baseDate.getDate() + (dayIndex - 1));
                }
                return date;
            }

            // ----- Datos de ejemplo (eventos iniciales) -----
            const initialEvents = [
                { id: '1', title: 'Matem√°ticas - Ana', professor: 'Ana', day: 1, startTime: '10:00', endTime: '11:30', color: 'blue' },
                { id: '2', title: 'F√≠sica - Luis', professor: 'Luis', day: 2, startTime: '14:00', endTime: '15:30', color: 'green' },
                { id: '3', title: 'Qu√≠mica - Carla', professor: 'Carla', day: 3, startTime: '08:00', endTime: '09:30', color: 'orange' },
                { id: '4', title: 'Historia - Marta', professor: 'Marta', day: 4, startTime: '16:00', endTime: '17:30', color: 'purple' },
                { id: '5', title: 'Matem√°ticas - Ana', professor: 'Ana', day: 5, startTime: '12:00', endTime: '13:30', color: 'blue' },
            ];

            // Convertir eventos iniciales a objetos con start/end Date
            function buildEventsFromArray(arr) {
                return arr.map(e => {
                    const date = getDateForDay(e.day);
                    const [startH, startM] = e.startTime.split(':');
                    const [endH, endM] = e.endTime.split(':');
                    const start = new Date(date);
                    start.setHours(parseInt(startH), parseInt(startM), 0);
                    const end = new Date(date);
                    end.setHours(parseInt(endH), parseInt(endM), 0);
                    return {
                        id: e.id,
                        title: e.title,
                        start: start,
                        end: end,
                        backgroundColor: e.color === 'blue' ? '#3b82f6' : e.color === 'green' ? '#22c55e' : e.color === 'orange' ? '#f97316' : '#a855f7',
                        borderColor: 'white',
                        textColor: 'white',
                        extendedProps: { 
                            professor: e.professor,
                            day: e.day,
                            startTime: e.startTime,
                            endTime: e.endTime,
                            color: e.color
                        }
                    };
                });
            }

            let events = buildEventsFromArray(initialEvents);

            // ----- Inicializar FullCalendar con plugins -----
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                plugins: [ FullCalendar.DayGrid, FullCalendar.TimeGrid, FullCalendar.Interaction ],
                initialView: 'timeGridWeek',
                initialDate: baseDate,
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                slotMinTime: '07:00:00',
                slotMaxTime: '21:00:00',
                allDaySlot: false,
                height: 'auto',
                locale: 'es',
                buttonText: {
                    today: 'Hoy',
                    month: 'Mes',
                    week: 'Semana',
                    day: 'D√≠a'
                },
                events: events,
                eventClick: function(info) {
                    // Abrir modal en modo edici√≥n con los datos del evento
                    openEditModal(info.event);
                }
            });

            calendar.render();

            // ----- Referencias al modal y formulario -----
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const classForm = document.getElementById('classForm');
            const eventIdInput = document.getElementById('eventId');
            const titleInput = document.getElementById('title');
            const professorSelect = document.getElementById('professor');
            const daySelect = document.getElementById('day');
            const colorSelect = document.getElementById('color');
            const startTimeInput = document.getElementById('startTime');
            const endTimeInput = document.getElementById('endTime');
            const deleteBtn = document.getElementById('deleteEventBtn');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const openModalBtn = document.getElementById('openModalBtn');
            const todayBtn = document.getElementById('todayBtn');

            // Abrir modal para nuevo evento
            function openNewModal() {
                modalTitle.innerText = '‚ûï Nueva clase';
                eventIdInput.value = '';
                classForm.reset();
                startTimeInput.value = '09:00';
                endTimeInput.value = '10:30';
                deleteBtn.classList.add('hidden');
                modal.classList.remove('hidden');
            }

            // Abrir modal para editar evento
            function openEditModal(event) {
                modalTitle.innerText = '‚úèÔ∏è Editar clase';
                eventIdInput.value = event.id;
                
                // Rellenar campos con los datos del evento
                titleInput.value = event.title.replace(` - ${event.extendedProps.professor}`, ''); // Quitamos el profesor del t√≠tulo si est√°
                professorSelect.value = event.extendedProps.professor;
                daySelect.value = event.extendedProps.day;
                colorSelect.value = event.extendedProps.color;
                startTimeInput.value = event.extendedProps.startTime;
                endTimeInput.value = event.extendedProps.endTime;
                
                deleteBtn.classList.remove('hidden');
                modal.classList.remove('hidden');
            }

            // Cerrar modal
            function closeModal() {
                modal.classList.add('hidden');
            }

            openModalBtn.addEventListener('click', openNewModal);
            closeModalBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            // Bot√≥n Hoy externo
            todayBtn.addEventListener('click', () => {
                calendar.today();
            });

            // Guardar (crear o actualizar)
            classForm.addEventListener('submit', (e) => {
                e.preventDefault();

                const id = eventIdInput.value;
                const title = titleInput.value;
                const professor = professorSelect.value;
                const day = parseInt(daySelect.value);
                const color = colorSelect.value;
                const startTime = startTimeInput.value;
                const endTime = endTimeInput.value;

                if (startTime >= endTime) {
                    alert('La hora de fin debe ser posterior a la de inicio');
                    return;
                }

                // Generar ID si es nuevo
                const eventId = id || Date.now().toString();

                // Crear objeto de evento para FullCalendar
                const date = getDateForDay(day);
                const [startH, startM] = startTime.split(':');
                const [endH, endM] = endTime.split(':');
                const start = new Date(date);
                start.setHours(parseInt(startH), parseInt(startM), 0);
                const end = new Date(date);
                end.setHours(parseInt(endH), parseInt(endM), 0);

                const fullTitle = `${title} - ${professor}`;
                const bgColor = color === 'blue' ? '#3b82f6' : color === 'green' ? '#22c55e' : color === 'orange' ? '#f97316' : '#a855f7';

                const newEvent = {
                    id: eventId,
                    title: fullTitle,
                    start: start,
                    end: end,
                    backgroundColor: bgColor,
                    borderColor: 'white',
                    textColor: 'white',
                    extendedProps: {
                        professor: professor,
                        day: day,
                        startTime: startTime,
                        endTime: endTime,
                        color: color
                    }
                };

                if (id) {
                    // Actualizar: eliminar el anterior y agregar el nuevo
                    const oldEvent = calendar.getEventById(id);
                    if (oldEvent) oldEvent.remove();
                    calendar.addEvent(newEvent);
                    
                    // Actualizar tambi√©n en el array events (para mantener consistencia)
                    events = events.filter(ev => ev.id !== id);
                    events.push(newEvent);
                } else {
                    // Crear nuevo
                    calendar.addEvent(newEvent);
                    events.push(newEvent);
                }

                closeModal();
            });

            // Eliminar evento
            deleteBtn.addEventListener('click', () => {
                const id = eventIdInput.value;
                if (id && confirm('¬øEliminar esta clase?')) {
                    const event = calendar.getEventById(id);
                    if (event) event.remove();
                    events = events.filter(ev => ev.id !== id);
                    closeModal();
                }
            });

            // Exponer objeto para depuraci√≥n
            window.calendar = calendar;
        })();
    </script>
</body>
</html>